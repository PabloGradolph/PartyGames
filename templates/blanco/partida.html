{% extends "base.html" %}
{% load static %}
{% block title %}Partida {{ partida.codigo }}{% endblock %}
{% block content %}
<div class="text-center">
    <h2 class="mb-4">Sala de la partida</h2>
    {% if partida.estado != 'en_juego' %}
        <p class="lead">Código de la partida:</p>
        <div class="display-4 fw-bold mb-3">{{ partida.codigo }}</div>
        <div class="alert alert-info">Comparte este código con tus amigos para que se unan a la partida.</div>
    {% endif %}
    
    <p class="mb-4">
        Estado: 
        <span id="estado-partida" class="badge bg-info">{{ partida.estado }}</span>
        {% if partida.estado == 'en_juego' %}
            <span class="badge bg-primary ms-2">Ronda {{ partida.ronda_actual }}</span>
        {% endif %}
        {% if partida.ronda_terminada %}
            <span class="badge bg-warning ms-2">Ronda terminada</span>
        {% endif %}
    </p>
    
    {% if mensaje %}
        <div class="alert alert-success">{{ mensaje }}</div>
    {% endif %}
    
    {% if palabra and not mi_gameplayer.eliminado %}
        <div class="alert alert-primary display-6">Tu palabra secreta: <b>{{ palabra }}</b></div>
    {% endif %}
    
    {% if mi_gameplayer.es_impostor and mi_gameplayer.eliminado and not partida.ronda_terminada and not mi_gameplayer.ya_intento_adivinar %}
        <div class="alert alert-warning">
            <h5>¡Has sido eliminado como impostor!</h5>
            <p>Ahora puedes intentar adivinar la palabra de los buenos para ganar 3 puntos. Si aciertas, la ronda termina y pasamos a la siguiente.</p>
            <form method="post" class="mt-3">
                {% csrf_token %}
                <div class="input-group mb-3 justify-content-center">
                    <input type="text" name="palabra_adivinada" class="form-control" style="max-width: 300px;" placeholder="Escribe la palabra que crees que es..." required>
                    <button type="submit" name="adivinar_palabra" class="btn btn-primary">Adivinar</button>
                </div>
            </form>
        </div>
    {% elif mi_gameplayer.es_impostor and mi_gameplayer.eliminado and mi_gameplayer.ya_intento_adivinar and not partida.ronda_terminada %}
        <div class="alert alert-secondary">
            <h5>Ya intentaste adivinar la palabra</h5>
            <p>Como impostor eliminado, ya has usado tu oportunidad de adivinar la palabra. Debes esperar a que termine la ronda.</p>
        </div>
    {% endif %}
    
    <!-- Información para otros jugadores sobre impostores eliminados -->
    {% if not mi_gameplayer.es_impostor and not mi_gameplayer.eliminado and not partida.ronda_terminada %}
        {% for jugador in jugadores_eliminados %}
            {% if jugador.es_impostor and not jugador.ya_intento_adivinar %}
                <div class="alert alert-info">
                    <h5>Impostor eliminado</h5>
                    <p>{{ jugador.user.username }} ha sido eliminado como impostor y puede intentar adivinar la palabra. La ronda continuará hasta que todos los impostores eliminados hayan intentado adivinar.</p>
                </div>
            {% endif %}
        {% endfor %}
    {% endif %}
    
    <!-- Tabla de puntos -->
    {% if partida.estado == 'en_juego' %}
        <div class="row mb-4">
            <div class="col-12">
                <h4>Puntuación</h4>
                <div class="table-responsive">
                    <table id="puntuacion-table" class="table table-dark table-striped">
                        <thead>
                            <tr>
                                <th>Jugador</th>
                                <th>Puntos</th>
                                <th>Ronda actual</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for jugador in jugadores %}
                                <tr>
                                    <td>
                                        {{ jugador.user.username }}
                                        {% if partida.host == jugador.user %} 
                                            <span class="badge bg-success ms-2">Host</span>
                                        {% endif %}
                                    </td>
                                    <td><span class="badge bg-warning points">{{ jugador.puntos }}</span></td>
                                    <td>{{ jugador.ronda_actual }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% endif %}
    
    <div class="row">
        <!-- Jugadores activos -->
        <div class="col-md-6">
            <h4>Jugadores activos (<span id="jugadores-activos-count">{{ jugadores_activos|length }}</span>)</h4>
            <ul id="jugadores-activos-list" class="list-group list-group-flush mb-3">
                {% for jugador in jugadores_activos %}
                    <li class="list-group-item bg-dark text-light d-flex justify-content-between align-items-center">
                        <span>
                            {{ jugador.user.username }}
                            {% if partida.host == jugador.user %} 
                                <span class="badge bg-success ms-2">Host</span>
                            {% endif %}
                            {% comment %} No mostrar roles durante el juego {% endcomment %}
                        </span>
                        {% if es_host %}
                            {% if partida.estado != 'en_juego' and not jugador.user == user %}
                                <form method="post" style="display:inline;">
                                    {% csrf_token %}
                                    <input type="hidden" name="expulsar" value="{{ jugador.user.id }}">
                                    <button type="submit" class="btn btn-sm btn-danger">Expulsar</button>
                                </form>
                            {% elif partida.estado == 'en_juego' and not partida.ronda_terminada and not jugador.eliminado %}
                                <form method="post" style="display:inline;">
                                    {% csrf_token %}
                                    <input type="hidden" name="eliminar_ronda" value="{{ jugador.user.id }}">
                                    <button type="submit" class="btn btn-sm btn-warning boton-juego" onclick="partidaWS.eliminarJugador({{ jugador.id }})">Eliminar de ronda</button>
                                </form>
                            {% endif %}
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        </div>
        
        <!-- Jugadores eliminados -->
        {% if jugadores_eliminados %}
        <div class="col-md-6">
            <h4>Eliminados de la ronda (<span id="jugadores-eliminados-count">{{ jugadores_eliminados|length }}</span>)</h4>
            <ul id="jugadores-eliminados-list" class="list-group list-group-flush mb-3">
                {% for jugador in jugadores_eliminados %}
                    <li class="list-group-item bg-secondary text-light d-flex justify-content-between align-items-center">
                        <span>
                            {{ jugador.user.username }}
                            {% if partida.host == jugador.user %} 
                                <span class="badge bg-success ms-2">Host</span>
                            {% endif %}
                            {% comment %} Mostrar roles solo de los eliminados {% endcomment %}
                            {% if jugador.es_impostor %}
                                <span class="badge bg-danger ms-2">Impostor</span>
                            {% elif jugador.es_infiltrado %}
                                <span class="badge bg-warning ms-2">Infiltrado</span>
                            {% elif jugador.es_bueno %}
                                <span class="badge bg-info ms-2">Bueno</span>
                            {% endif %}
                        </span>
                        <span class="badge bg-secondary">Eliminado</span>
                    </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
    
        <!-- Información de roles (visible para todos) -->
    {% if partida.estado == 'en_juego' and not partida.ronda_terminada %}
        <div class="alert alert-info mt-3">
            <strong>Jugadores activos:</strong> {{ jugadores_activos|length }} | 
            <strong>Eliminados:</strong> {{ jugadores_eliminados|length }}
            <br><strong>Buenos activos:</strong> {{ buenos_activos|length }} | 
            <strong>Infiltrados activos:</strong> {{ infiltrados_activos|length }} | 
            <strong>Impostores activos:</strong> {{ impostores_activos|length }}
        </div>
    {% endif %}
    
    <!-- Controles del host -->
    {% if es_host %}
        <div class="mt-4">
            <button type="button" onclick="partidaWS.terminarPartida()" class="btn btn-outline-danger mb-2">Terminar partida</button>
            
            {% if partida.estado == 'en_juego' %}
                {% if partida.ronda_terminada %}
                    <button type="button" onclick="partidaWS.nuevaRonda()" class="btn btn-success mt-2">Nueva ronda de palabras</button>
                {% endif %}
            {% elif puede_empezar %}
                <button type="button" onclick="partidaWS.iniciarPartida()" class="btn btn-success mt-2">Empezar partida</button>
            {% else %}
                <div class="alert alert-warning mt-2">Se necesitan al menos 4 jugadores para empezar la partida.</div>
            {% endif %}
        </div>
    {% endif %}
    
    <!-- Información del juego -->
    {% if partida.estado == 'en_juego' and not partida.ronda_terminada %}
        <div class="alert alert-info mt-3">
            <h5>Instrucciones del juego - Ronda {{ partida.ronda_actual }}</h5>
            <ul class="text-start">
                {% if jugadores_activos|length == 4 %}
                    <li><strong>Distribución de roles:</strong> 3 buenos (tienen la palabra correcta), 1 infiltrado (tienen una palabra parecida)</li>
                {% elif jugadores_activos|length == 5 %}
                    <li><strong>Distribución de roles:</strong> 3 buenos (tienen la palabra correcta), 1 infiltrado (tienen una palabra parecida), 1 impostor (no tienen palabra)</li>
                {% elif jugadores_activos|length == 6 %}
                    <li><strong>Distribución de roles:</strong> 4 buenos (tienen la palabra correcta), 1 infiltrado (tienen una palabra parecida), 1 impostor (no tienen palabra)</li>
                {% elif jugadores_activos|length == 7 %}
                    <li><strong>Distribución de roles:</strong> 4 buenos (tienen la palabra correcta), 2 infiltrados (tienen una palabra parecida), 1 impostor (no tienen palabra)</li>
                {% elif jugadores_activos|length == 8 %}
                    <li><strong>Distribución de roles:</strong> 5 buenos (tienen la palabra correcta), 2 infiltrados (tienen una palabra parecida), 1 impostor (no tienen palabra)</li>
                {% elif jugadores_activos|length == 9 %}
                    <li><strong>Distribución de roles:</strong> 5 buenos (tienen la palabra correcta), 2 infiltrados (tienen una palabra parecida), 2 impostores (no tienen palabra)</li>
                {% endif %}
                <li><strong>Instrucciones: </strong>Cada persona debe decir una palabra relacionada con la palabra secreta. Cuando todos los jugadores hayan dicho una palabra se vota para eliminar a un jugador. El jugador eliminado revela su rol y en función de éste continúa la ronda o se hace recuento de puntos.</li>
                <li><strong>Objetivo:</strong> Los buenos deben eliminar a infiltrados e impostores para ganar puntos.</li>
                <li><strong>Infiltrados: </strong> Deben llegar hasta el final (1 vs 1) para ganar puntos.</li>
                <li><strong>Impostores: </strong> Deben llegar hasta el final (1 vs 1) o acertar la palabra de los buenos cuando sean eliminados para ganar puntos.</li>
                <li><strong>Importante:</strong> Solo sabrás tu rol cuando seas eliminado (excepto si eres impostor que ya lo sabes)</li>
                <li><strong>Sistema de puntos:</strong>
                    <ul>
                        <li>Impostor gana 3 puntos si llega al final o si es eliminado y acierta la palabra</li>
                        <li>Infiltrado gana 2 puntos si llega al final</li>
                        <li>Buenos ganan 1 punto cada uno si eliminan a todos los malos, sólo los buenos que queden vivos puntuarán.</li>
                    </ul>
                </li>
            </ul>
        </div>
    {% endif %}
    
    <!-- Resumen de la ronda terminada -->
    {% if partida.ronda_terminada %}
        <div class="alert alert-warning mt-3">
            <h5>Ronda {{ partida.ronda_actual }} terminada</h5>
            <p>Los puntos han sido asignados según el resultado. El host puede iniciar una nueva ronda de palabras.</p>
            {% if es_host %}
                <p><strong>Resultado final:</strong> Buenos activos: {{ buenos_activos|length }}, Infiltrados activos: {{ infiltrados_activos|length }}, Impostores activos: {{ impostores_activos|length }}</p>
            {% endif %}
        </div>
    {% endif %}
</div>

<!-- WebSocket Script -->
<script src="{% static 'js/websocket.js' %}"></script>
<script>
    // Inicializar WebSocket cuando se carga la página
    document.addEventListener('DOMContentLoaded', function() {
        const codigoPartida = '{{ partida.codigo }}';
        window.partidaWS = new PartidaWebSocket(codigoPartida);
        
        // Limpiar WebSocket cuando se cierre la página
        window.addEventListener('beforeunload', function() {
            if (window.partidaWS) {
                window.partidaWS.disconnect();
            }
        });
    });
</script>
{% endblock %} 